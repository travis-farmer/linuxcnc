(customized, based on https://github.com/Funkenjaeger )
(was for a rack tool changer, now for a carousel.)
o<toolchange> sub
o999 if[#<_task> NE 0]
 M70                                                                (Save modal state)
 M5                                                                 (Turn spindle off)
 G4 P6                                                             (Dwell for spindle stop)
 M9                                                                 (Turn coolant off)
 G17 G20 G40 G64 P0.001 G80 G94 G97 G98                             (Baseline modal state)

o500 if[#<_current_tool> EQ #<_selected_tool>]                     (Same tool as before so no need to do anything.)

o500 else
	(This is a different tool.)

	o210 if [#<_hal[tool-change-mode]>]
		; AUTOMATIC TOOL CHANGE
		#<pocket_current_a> = [#<_ini[TOOL_CHANGE]POCKET_1_A> + [[#<_current_pocket> - 1] * #<_ini[TOOL_CHANGE]POCKET_DELTA_A>]]
		#<pocket_selected_a> = [#<_ini[TOOL_CHANGE]POCKET_1_A> + [[#<_selected_pocket> - 1] * #<_ini[TOOL_CHANGE]POCKET_DELTA_A>]]
		#<pocket_approach_y> = [#<_ini[TOOL_CHANGE]POCKET_Y> + #<_ini[TOOL_CHANGE]POCKET_SAFE_MOVE_Y>]
		#<pocket_safe_z> = [#<_ini[TOOL_CHANGE]POCKET_Z> + #<_ini[TOOL_CHANGE]POCKET_SAFE_RETRACT_Z>]

		M66 P3 L0																(Check air pressure sensor, TJF)
		o216 if [#5399 EQ 0]
			(abort,No air pressure)
		o216 endif

		o211 if [#<_current_tool> NE 0]
			;M66 P[#<_current_pocket> + 9] L0												(Check tool pocket sensor, TODO)
			;o215 if [#5399 EQ 1]
				;(abort,Current pocket has a tool in it)
			;o215 endif
		o211 endif

		o212 if [#<_selected_tool> NE 0]
			;M66 P[#<_selected_pocket> + 9] L0 												(Check tool pocket sensor, TODO)
			;o221 if [#5399 EQ 0]
				;(abort,Selected pocket has no tool in it)
			;o221 endif
		o212 endif

		; Basic sanity checks done - start the tool change process
		G40

		G90 G0                                                          (Absolute distance mode Rapid move)
		G53 Z#<_ini[TOOLSENSOR]Z_SAFE>	   	 (Change Z Position)
        M64 P1                                                                              (move in tool carousel)
		o213 if [#<_current_tool> NE 0]
			G53 G0 A#<pocket_current_a> Y#<pocket_approach_y> X#<_ini[TOOL_CHANGE]POCKET_X>	(Rapid AYX to approach position for current tool's pocket)
			G53 G0 Z#<_ini[TOOL_CHANGE]POCKET_Z> 											(Rapid Z to pocket height)
			G53 G1 Y#<_ini[TOOL_CHANGE]POCKET_Y> F#<_ini[TOOL_CHANGE]APPROACH_VELOCITY_Y>	(Slot tool into pocket)
			G4 P0.1
			;M66 P[#<_current_pocket> + 9] L0
			;o222 if [#5399 EQ 0]
				;(abort,Failed to deposit current tool)
			;o222 endif
			M64 P0 																			(Release drawbar)
            M66 P2 L3 Q10							                                    	(Wait for drawbar release, TJF)
			G53 G0 Z[#<_ini[TOOL_CHANGE]POCKET_Z> + #<_ini[TOOL_CHANGE]DRAWBAR_OFFSET>]
			G53 G0 Z#<pocket_safe_z>														(Rapid Z to clear tool holders)
			G4 P0.1
			;M66 P1 L0
			;o313 if [#5399 EQ 1]
				;(abort,Tool not in pocket after Z retract)
			;o313 endif
			M65 P0
			M61 Q0																			(Set current tool to 0)
		o213 endif

		o214 if [#<_selected_tool> NE 0]
			G53 G0 Z#<pocket_safe_z>
																(Wait for drawbar release, TJF)
			G53 G0 A#<pocket_selected_a> Y#<_ini[TOOL_CHANGE]POCKET_Y> X#<_ini[TOOL_CHANGE]POCKET_X>	(Rapid X over selected tool)
			M64 P0 																			(Release drawbar)
            M66 P2 L3 Q10
			G53 G1 Z[[#<_ini[TOOL_CHANGE]POCKET_Z> + #<_ini[TOOL_CHANGE]DRAWBAR_OFFSET>]] F#<_ini[TOOL_CHANGE]APPROACH_VELOCITY_Z>	(Move Z onto selected tool)
			M63 P0 														(Engage drawbar, synchronized with the following move)
			G53 G0 Z#<_ini[TOOL_CHANGE]POCKET_Z>
			M66 P2 L4 Q10                            										(Wait for drawbar engagement, TJF)
			G53 G1 Y#<pocket_approach_y> F#<_ini[TOOL_CHANGE]APPROACH_VELOCITY_Y>			(Slot tool out of pocket)
			;M66 P1 L0
			;o315 if [#5399 EQ 0]
				;(abort,Failed to remove selected tool from pocket)
			;o315 endif
			G53 G0 Z0																		(Rapid retract Z)
			M61 Q#<_selected_tool>															(Set current tool)
		o214 else
			M65 P0																			(Engage drawbar immediately)
			G53 G0 Z0
			G53 G0 X0 Y0
		o214 endif
		M65 P1                                                                               (Move out tool carousel)
	o210 else
		; MANUAL TOOL CHANGE
		G40
		G90 G0															(Absolute distance mode Rapid move)
		G53 Z#<_ini[TOOLSENSOR]Z_SAFE>									(Change Z Position)

		G59.3															(Switch temporarily to G59.3 WCS for probing)
		G10 L2 P9 X0 Y0 Z0												(Zero out work coordinate offsets in G59.3)

		G53 X#<_ini[TOOL_CHANGE]MANUAL_CHANGE_LOC_X> Y#<_ini[TOOL_CHANGE]MANUAL_CHANGE_LOC_Y>   	 	(Move XY to manual change position)
		M6 T#<_selected_tool>											(Do built-in M6 routine - pops up prompt)
	o210 endif

 o220 if [#<_selected_tool> NE 0]
  ;M201                                                                 (Probe new tool)
 o220 endif

o500 endif

M72                                                                	(Restore saved modal state)
o501 if [EXISTS[#<_new_tlo>]]
	G43.1 Z#<_new_tlo>													(Re-Set Dynamic TLO)
o501 else
	G43.1 Z0
o501 endif

o999 endif
o<toolchange> endsub
M2
